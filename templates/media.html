{% extends "base.html" %}

{% block title %}Media - Digital Signage Manager{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-images me-2"></i>Media Library</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
            <i class="fas fa-upload me-2"></i>Upload Media
        </button>
    </div>

    {% if media_files %}
    <div class="row">
        {% for media in media_files %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center">
                            {% if media.file_type == 'image' %}
                            <i class="fas fa-image text-primary me-2"></i>
                            {% elif media.file_type == 'stream' %}
                            <i class="fas fa-broadcast-tower text-info me-2"></i>
                            {% else %}
                            <i class="fas fa-video text-danger me-2"></i>
                            {% endif %}
                            <span class="badge bg-{{ 'primary' if media.file_type == 'image' else ('info' if media.file_type == 'stream' else 'danger') }}">
                                {% if media.file_type == 'stream' %}
                                    {{ media.stream_type|upper }} Stream
                                {% else %}
                                    {{ media.file_type|title }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <!-- Move dropdown to its own row to avoid overlap -->
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title text-truncate mb-0" title="{{ media.original_filename }}">
                            {{ media.original_filename }}
                        </h6>
                        <div class="btn-group ms-2" role="group">
                            {% if media.file_type == 'stream' %}
                            <a href="{{ media.stream_url }}" target="_blank" 
                               class="btn btn-sm btn-outline-info" title="Open Stream">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            {% else %}
                            <a href="{{ url_for('main.uploaded_file', filename=media.filename) }}" target="_blank" 
                               class="btn btn-sm btn-outline-secondary" title="Preview">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% endif %}
                            <form method="POST" action="{{ url_for('main.delete_media', media_id=media.id) }}" 
                                  class="d-inline"
                                  onsubmit="return confirm('Are you sure you want to delete this media file?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    {% if media.file_type == 'image' %}
                    <div class="text-center mb-3">
                        <img src="{{ url_for('main.uploaded_file', filename=media.filename) }}" 
                             class="img-fluid rounded" style="max-height: 150px; object-fit: cover;">
                    </div>
                    {% elif media.file_type == 'stream' %}
                    <div class="text-center mb-3 bg-gradient rounded p-4" style="background: linear-gradient(135deg, #1e3c72, #2a5298); min-height: 150px; display: flex; align-items: center; justify-content: center;">
                        <div>
                            <i class="fas fa-signal fa-3x text-info mb-2" style="animation: pulse 2s infinite;"></i>
                            <br>
                            <small class="text-light">{{ media.stream_type|upper }} Live Stream</small>
                            <br>
                            <small class="text-muted" style="word-break: break-all;">{{ media.stream_url[:50] }}{% if media.stream_url|length > 50 %}...{% endif %}</small>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center mb-3 position-relative">
                        <video class="img-fluid rounded video-thumbnail" 
                               style="max-height: 150px; width: auto; object-fit: cover;"
                               preload="metadata"
                               muted
                               playsinline
                               webkit-playsinline
                               data-filename="{{ media.filename }}">
                            <source src="{{ url_for('main.uploaded_file', filename=media.filename) }}" type="video/mp4">
                        </video>
                        <div class="video-overlay position-absolute top-50 start-50 translate-middle">
                            <i class="fas fa-play-circle fa-3x text-white" style="text-shadow: 0 0 10px rgba(0,0,0,0.8);"></i>
                        </div>
                    </div>
                    {% endif %}
                    
                    
                    <div class="row text-center">
                        {% if media.file_type == 'stream' %}
                        <div class="col-6">
                            <small class="text-muted">Type</small><br>
                            <strong>{{ media.stream_type|upper }}</strong>
                        </div>
                        {% else %}
                        <div class="col-6">
                            <small class="text-muted">Size</small><br>
                            <strong>{{ (media.file_size / 1024 / 1024)|round(1) }} MB</strong>
                        </div>
                        {% endif %}
                        <div class="col-6">
                            <small class="text-muted">Added</small><br>
                            <strong>{{ media.created_at.strftime('%m/%d/%y') }}</strong>
                        </div>
                    </div>
                    
                    {% if media.duration %}
                    <div class="mt-2 text-center">
                        <small class="text-muted">Duration: {{ media.duration }}s</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-images fa-4x text-muted mb-3"></i>
            <h4>No Media Files</h4>
            <p class="text-muted">Upload images and videos to create your digital signage content.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="fas fa-upload me-2"></i>Upload First Media
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add Media</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            
            <!-- Media Type Tabs -->
            <div class="modal-body">
                <ul class="nav nav-tabs mb-4" id="mediaTypeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-panel" type="button" role="tab">
                            <i class="fas fa-upload me-2"></i>Upload File
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="stream-tab" data-bs-toggle="tab" data-bs-target="#stream-panel" type="button" role="tab">
                            <i class="fas fa-stream me-2"></i>Add Stream
                        </button>
                    </li>
                </ul>
                
                <!-- File Upload Tab -->
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="file-panel" role="tabpanel">
                        <form method="POST" action="{{ url_for('main.upload_media') }}" enctype="multipart/form-data" id="fileUploadForm">
                            <div class="mb-3">
                                <label for="mediaFile" class="form-label">Select Media File</label>
                                <input type="file" class="form-control" id="mediaFile" name="file" 
                                       accept=".png,.jpg,.jpeg,.gif,.mp4,.avi,.mov,.mkv,.webm">
                                <div class="form-text">
                                    Supported formats: PNG, JPG, GIF (images) | MP4, AVI, MOV, MKV, WebM (videos)
                                    <br>Maximum file size: 500MB
                                </div>
                            </div>
                            
                            <div id="filePreview" class="text-center" style="display: none;">
                                <img id="imagePreview" class="img-fluid rounded mb-2" style="max-height: 200px;">
                                <div id="videoPreview">
                                    <i class="fas fa-video fa-3x text-muted"></i>
                                    <p class="mt-2 mb-0">Video selected</p>
                                </div>
                            </div>
                            
                            <div class="modal-footer border-0">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-upload me-2"></i>Upload File
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Stream URL Tab -->
                    <div class="tab-pane fade" id="stream-panel" role="tabpanel">
                        <form method="POST" action="{{ url_for('main.add_stream') }}" id="streamForm">
                            <div class="mb-3">
                                <label for="streamName" class="form-label">Stream Name</label>
                                <input type="text" class="form-control" id="streamName" name="stream_name" 
                                       placeholder="Enter a friendly name for this stream" required>
                                <div class="form-text">This name will appear in your media library</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="streamUrl" class="form-label">Stream URL</label>
                                <input type="url" class="form-control" id="streamUrl" name="stream_url" 
                                       placeholder="rtmp://example.com/live/stream or https://example.com/playlist.m3u8" required>
                                <div class="form-text">
                                    Supported formats: RTMP, HLS (M3U8), HTTP Live Streams
                                    <br><strong>Examples:</strong>
                                    <br>• <code>rtmp://live.example.com/live/streamkey</code>
                                    <br>• <code>https://example.com/stream/playlist.m3u8</code>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="streamType" class="form-label">Stream Type</label>
                                <select class="form-select" id="streamType" name="stream_type" required>
                                    <option value="">Select stream type</option>
                                    <option value="rtmp">RTMP Stream</option>
                                    <option value="hls">HLS (M3U8)</option>
                                    <option value="http">HTTP Stream</option>
                                </select>
                            </div>
                            
                            <div id="streamPreview" class="text-center p-4 bg-dark rounded mb-3" style="display: none;">
                                <i class="fas fa-broadcast-tower fa-3x text-info mb-2"></i>
                                <p class="mb-0 text-light">Live Stream Ready</p>
                                <small class="text-muted" id="streamPreviewUrl"></small>
                            </div>
                            
                            <div class="modal-footer border-0">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-info">
                                    <i class="fas fa-stream me-2"></i>Add Stream
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// File upload preview
document.getElementById('mediaFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('filePreview');
    const imagePreview = document.getElementById('imagePreview');
    const videoPreview = document.getElementById('videoPreview');
    
    if (file) {
        preview.style.display = 'block';
        
        if (file.type.startsWith('image/')) {
            imagePreview.style.display = 'block';
            videoPreview.style.display = 'none';
            imagePreview.src = URL.createObjectURL(file);
        } else {
            imagePreview.style.display = 'none';
            videoPreview.style.display = 'block';
        }
    } else {
        preview.style.display = 'none';
    }
});

// Stream URL validation and preview
document.getElementById('streamUrl').addEventListener('input', function(e) {
    const url = e.target.value;
    const preview = document.getElementById('streamPreview');
    const previewUrl = document.getElementById('streamPreviewUrl');
    const streamType = document.getElementById('streamType');
    
    if (url) {
        // Auto-detect stream type based on URL
        if (url.startsWith('rtmp://')) {
            streamType.value = 'rtmp';
        } else if (url.includes('.m3u8')) {
            streamType.value = 'hls';
        } else if (url.startsWith('http://') || url.startsWith('https://')) {
            streamType.value = 'http';
        }
        
        // Show preview
        preview.style.display = 'block';
        previewUrl.textContent = url;
    } else {
        preview.style.display = 'none';
    }
});

// Stream form validation
document.getElementById('streamForm').addEventListener('submit', function(e) {
    const url = document.getElementById('streamUrl').value;
    const streamType = document.getElementById('streamType').value;
    
    // Validate URL format based on stream type
    let isValid = false;
    if (streamType === 'rtmp' && url.startsWith('rtmp://')) {
        isValid = true;
    } else if (streamType === 'hls' && (url.includes('.m3u8') || url.includes('m3u8'))) {
        isValid = true;
    } else if (streamType === 'http' && (url.startsWith('http://') || url.startsWith('https://'))) {
        isValid = true;
    }
    
    if (!isValid) {
        e.preventDefault();
        alert('Please ensure the URL format matches the selected stream type:\n' +
              '• RTMP: rtmp://server/path\n' +
              '• HLS: URL containing .m3u8\n' +
              '• HTTP: http:// or https:// URL');
        return false;
    }
});

// Video thumbnail functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add click-to-preview functionality for video thumbnails
    document.querySelectorAll('.video-thumbnail').forEach(video => {
        const overlay = video.nextElementSibling;
        
        // Handle better thumbnail frame loading
        video.addEventListener('loadedmetadata', function() {
            // Try to seek to 1 second for better thumbnail if possible
            if (this.seekable.length > 0 && this.duration > 2) {
                try {
                    this.currentTime = 1;
                } catch (e) {
                    console.log('Could not seek video for thumbnail:', e);
                }
            }
        });
        
        // Handle seeking errors gracefully
        video.addEventListener('error', function(e) {
            console.log('Video thumbnail error:', e);
        });
        
        // Toggle play/pause function
        const togglePlay = function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Video clicked! State:', {
                paused: video.paused,
                readyState: video.readyState,
                networkState: video.networkState,
                error: video.error
            });
            
            if (video.paused) {
                // Reset to beginning before playing
                video.currentTime = 0;
                video.play().then(() => {
                    console.log('Video started playing successfully');
                    if (overlay) overlay.style.opacity = '0';
                }).catch(err => {
                    console.error('Video play failed:', err);
                    console.error('Video state:', {
                        readyState: video.readyState,
                        networkState: video.networkState,
                        error: video.error
                    });
                    // Enable controls for manual debugging
                    video.setAttribute('controls', '');
                    alert('Video play failed: ' + err.message + '\nControls enabled for debugging');
                });
            } else {
                video.pause();
                console.log('Video paused');
                if (overlay) overlay.style.opacity = '1';
            }
        };
        
        // Add click handler to video element itself
        video.addEventListener('click', togglePlay);
        
        // Also add to overlay for redundancy
        if (overlay) {
            overlay.style.cursor = 'pointer';
            overlay.addEventListener('click', togglePlay);
        } else {
            console.log('No overlay found for video');
        }
        
        // Reset overlay when video ends
        video.addEventListener('ended', function() {
            if (overlay) {
                overlay.style.opacity = '1';
            }
            // Reset to thumbnail frame (1 second)
            try {
                this.currentTime = 1;
            } catch (e) {
                console.log('Could not reset thumbnail:', e);
            }
        });
        
        // Hide overlay when playing
        video.addEventListener('play', function() {
            if (overlay) {
                overlay.style.opacity = '0';
            }
        });
        
        // Show overlay when paused
        video.addEventListener('pause', function() {
            if (overlay) {
                overlay.style.opacity = '1';
            }
        });
        
        // Force reload if stuck on first frame
        video.addEventListener('canplay', function() {
            if (this.currentTime === 0 && this.duration > 2) {
                try {
                    this.currentTime = 1;
                } catch (e) {
                    // Ignore if seeking fails
                }
            }
        });
    });
});
</script>

<style>
.video-overlay {
    pointer-events: all;
    cursor: pointer;
    transition: opacity 0.3s ease;
    z-index: 2; /* Keep overlay below dropdown buttons */
}

.video-thumbnail:hover + .video-overlay {
    cursor: pointer;
}

.video-thumbnail {
    cursor: pointer;
    z-index: 1; /* Keep video element below overlay */
}

/* Ensure dropdown buttons are above video content */
.card-header .dropdown {
    position: relative;
    z-index: 10 !important; /* Higher than video content */
}

.card-header .dropdown-toggle {
    z-index: 11 !important; /* Even higher for the button itself */
}

.card-header .dropdown-menu {
    z-index: 12 !important; /* Highest for the dropdown menu */
}

/* Ensure video preview doesn't interfere with card header controls */
.card-body .position-relative {
    z-index: 1; /* Keep video container below header */
}
</style>
{% endblock %}
