{% extends "base.html" %}

{% block title %}Edit Playlist: {{ playlist.name }} - Digital Signage Manager{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.playlists') }}">Playlists</a></li>
                    <li class="breadcrumb-item active">{{ playlist.name }}</li>
                </ol>
            </nav>
            <h2><i class="fas fa-edit me-2"></i>Edit Playlist</h2>
        </div>
        <a href="{{ url_for('main.playlists') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Playlists
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Playlist Settings -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Playlist Settings</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('main.update_playlist', playlist_id=playlist.id) }}" id="playlistForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">Playlist Name *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ playlist.name }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="default_duration" class="form-label">Default Duration (seconds)</label>
                                <input type="number" class="form-control" id="default_duration" name="default_duration" 
                                       value="{{ playlist.default_duration }}" min="1" max="3600" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ playlist.description or '' }}</textarea>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="loop_playlist" name="loop_playlist" 
                                   {% if playlist.loop_playlist %}checked{% endif %}>
                            <label class="form-check-label" for="loop_playlist">
                                Loop playlist continuously
                            </label>
                        </div>
                </div>
            </div>

            <!-- Media Items -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Media Items</h5>
                </div>
                <div class="card-body">
                    <div id="mediaItems">
                        {% for item in playlist.items %}
                        <div class="media-item card mb-2">
                            <div class="card-body p-3">
                                <div class="row align-items-center">
                                    <div class="col-md-1">
                                        <div class="d-flex flex-column">
                                            <button type="button" class="btn btn-sm btn-outline-secondary mb-1" onclick="moveUp(this)">
                                                <i class="fas fa-arrow-up"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveDown(this)">
                                                <i class="fas fa-arrow-down"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <select name="media_ids" class="form-select" required>
                                            <option value="">Select media...</option>
                                            {% for media in media_files %}
                                            <option value="{{ media.id }}" data-type="{{ media.file_type }}" 
                                                    {% if media.id == item.media_file_id %}selected{% endif %}>
                                                {{ media.original_filename }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="input-group">
                                            <input type="number" name="durations" class="form-control" 
                                                   placeholder="Default" min="1" max="3600" 
                                                   value="{{ item.duration or '' }}">
                                            <span class="input-group-text">sec</span>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        {% if item.media_file.file_type == 'image' %}
                                        <i class="fas fa-image text-primary me-2"></i>
                                        {% else %}
                                        <i class="fas fa-video text-danger me-2"></i>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary" onclick="addItem()">
                        <i class="fas fa-plus me-2"></i>Add Media Item
                    </button>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary" onclick="setTimeout(debugFormData, 10)">
                        <i class="fas fa-save me-2"></i>Save Playlist
                    </button>
                    <a href="{{ url_for('main.playlists') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </div>
        </form>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Playlist Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Playlist Info</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <small class="text-muted">Created</small><br>
                            <strong>{{ playlist.created_at.strftime('%m/%d/%y') }}</strong>
                        </div>
                        <div class="col-6 mb-2">
                            <small class="text-muted">Updated</small><br>
                            <strong>{{ playlist.updated_at.strftime('%m/%d/%y') }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Items</small><br>
                            <strong id="itemCount">{{ playlist.items|length }}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Assigned</small><br>
                            <strong>{{ playlist.assigned_devices|length }} devices</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Media Library -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-images me-2"></i>Available Media</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if media_files %}
                    {% for media in media_files %}
                    <div class="d-flex align-items-center mb-2 p-2 border rounded">
                        {% if media.file_type == 'image' %}
                        <i class="fas fa-image text-primary me-2"></i>
                        {% else %}
                        <i class="fas fa-video text-danger me-2"></i>
                        {% endif %}
                        <div class="flex-grow-1">
                            <small class="fw-bold">{{ media.original_filename }}</small><br>
                            <small class="text-muted">{{ media.file_type|title }} â€¢ {{ (media.file_size / 1024 / 1024)|round(1) }} MB</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                onclick="quickAdd({{ media.id }}, '{{ media.original_filename }}', '{{ media.file_type }}')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No media files available. <a href="{{ url_for('main.media') }}">Upload some media</a> first.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store media options for dynamic creation
const mediaFiles = [
    {% for media in media_files %}
    {id: {{ media.id }}, name: "{{ media.original_filename }}", type: "{{ media.file_type }}"},
    {% endfor %}
];

function createMediaOptions() {
    let options = '<option value="">Select media...</option>';
    mediaFiles.forEach(media => {
        options += `<option value="${media.id}" data-type="${media.type}">${media.name}</option>`;
    });
    return options;
}

function addItem() {
    const container = document.getElementById('mediaItems');
    const form = document.getElementById('playlistForm');
    
    // Create the main div
    const itemDiv = document.createElement('div');
    itemDiv.className = 'media-item card mb-2';
    
    // Create card body
    const cardBody = document.createElement('div');
    cardBody.className = 'card-body p-3';
    
    // Create row
    const row = document.createElement('div');
    row.className = 'row align-items-center';
    
    // Create move buttons column
    const moveCol = document.createElement('div');
    moveCol.className = 'col-md-1';
    moveCol.innerHTML = `
        <div class="d-flex flex-column">
            <button type="button" class="btn btn-sm btn-outline-secondary mb-1" onclick="moveUp(this)">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveDown(this)">
                <i class="fas fa-arrow-down"></i>
            </button>
        </div>
    `;
    
    // Create media select column
    const selectCol = document.createElement('div');
    selectCol.className = 'col-md-5';
    const select = document.createElement('select');
    select.name = 'media_ids';
    select.className = 'form-select';
    select.required = true;
    // Form association handled by DOM placement
    select.onchange = function() { updateIcon(this); };
    select.innerHTML = createMediaOptions();
    selectCol.appendChild(select);
    
    // Create duration input column
    const durationCol = document.createElement('div');
    durationCol.className = 'col-md-3';
    const inputGroup = document.createElement('div');
    inputGroup.className = 'input-group';
    const durationInput = document.createElement('input');
    durationInput.type = 'number';
    durationInput.name = 'durations';
    durationInput.className = 'form-control';
    durationInput.placeholder = 'Default';
    durationInput.min = '1';
    durationInput.max = '3600';
    // Form association handled by DOM placement
    const inputGroupText = document.createElement('span');
    inputGroupText.className = 'input-group-text';
    inputGroupText.textContent = 'sec';
    inputGroup.appendChild(durationInput);
    inputGroup.appendChild(inputGroupText);
    durationCol.appendChild(inputGroup);
    
    // Create icon column
    const iconCol = document.createElement('div');
    iconCol.className = 'col-md-2';
    const iconSpan = document.createElement('span');
    iconSpan.className = 'media-icon';
    iconCol.appendChild(iconSpan);
    
    // Create delete button column
    const deleteCol = document.createElement('div');
    deleteCol.className = 'col-md-1';
    deleteCol.innerHTML = `
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(this)">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    // Assemble the structure
    row.appendChild(moveCol);
    row.appendChild(selectCol);
    row.appendChild(durationCol);
    row.appendChild(iconCol);
    row.appendChild(deleteCol);
    cardBody.appendChild(row);
    itemDiv.appendChild(cardBody);
    container.appendChild(itemDiv);
    
    updateItemCount();
    console.log('Added new media item with form association');
}

function removeItem(button) {
    button.closest('.media-item').remove();
    updateItemCount();
}

function moveUp(button) {
    const item = button.closest('.media-item');
    const prev = item.previousElementSibling;
    if (prev && prev.classList.contains('media-item')) {
        item.parentNode.insertBefore(item, prev);
    }
}

function moveDown(button) {
    const item = button.closest('.media-item');
    const next = item.nextElementSibling;
    if (next && next.classList.contains('media-item')) {
        item.parentNode.insertBefore(next, item);
    }
}

function updateIcon(select) {
    try {
        const option = select.selectedOptions[0];
        const iconContainer = select.closest('.row').querySelector('.media-icon');
        
        if (iconContainer && option && option.dataset.type) {
            const type = option.dataset.type;
            if (type === 'image') {
                iconContainer.innerHTML = '<i class="fas fa-image text-primary me-2"></i>';
            } else {
                iconContainer.innerHTML = '<i class="fas fa-video text-danger me-2"></i>';
            }
        } else if (iconContainer) {
            iconContainer.innerHTML = '';
        }
    } catch (error) {
        console.error('Error updating icon:', error);
    }
}

function updateItemCount() {
    const count = document.querySelectorAll('.media-item').length;
    const itemCountElement = document.getElementById('itemCount');
    if (itemCountElement) {
        itemCountElement.textContent = count;
    }
}

function quickAdd(mediaId, filename, type) {
    try {
        console.log('QuickAdd called with:', mediaId, filename, type);
        addItem();
        
        // Wait a moment for DOM to update
        setTimeout(() => {
            const lastItem = document.querySelector('.media-item:last-child');
            if (lastItem) {
                const select = lastItem.querySelector('select[name="media_ids"]');
                if (select) {
                    select.value = mediaId;
                    updateIcon(select);
                    console.log('Media item added successfully');
                } else {
                    console.error('Select element not found');
                }
            } else {
                console.error('Last item not found');
            }
        }, 50);
        
    } catch (error) {
        console.error('Error in quickAdd:', error);
    }
}

// Debug form submission
function debugFormData() {
    const form = document.getElementById('playlistForm');
    const formData = new FormData(form);
    console.log('Form data being submitted:');
    for (let [key, value] of formData.entries()) {
        console.log(key + ': ' + value);
    }
    
    // Additional debugging: check if media items exist in DOM
    const mediaItems = document.querySelectorAll('.media-item');
    const mediaSelects = document.querySelectorAll('select[name="media_ids"]');
    const durationInputs = document.querySelectorAll('input[name="durations"]');
    
    console.log('Media items found:', mediaItems.length);
    console.log('Media selects found:', mediaSelects.length);
    console.log('Duration inputs found:', durationInputs.length);
    
    // Check if selects are inside the form
    mediaSelects.forEach((select, index) => {
        console.log(`Select ${index}: value="${select.value}", inside form: ${form.contains(select)}`);
    });
}

// Initialize icons for existing items
document.addEventListener('DOMContentLoaded', function() {
    try {
        document.querySelectorAll('select[name="media_ids"]').forEach(updateIcon);
        updateItemCount();
        
        // Add form submit listener for debugging
        const form = document.getElementById('playlistForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                console.log('Form being submitted...');
                // Run debug before submission
                const mediaItems = document.querySelectorAll('.media-item');
                const mediaSelects = document.querySelectorAll('select[name="media_ids"]');
                const durationInputs = document.querySelectorAll('input[name="durations"]');
                
                console.log('Media items found:', mediaItems.length);
                console.log('Media selects found:', mediaSelects.length);
                console.log('Duration inputs found:', durationInputs.length);
                
                // Check if selects are inside the form and their values
                mediaSelects.forEach((select, index) => {
                    console.log(`Select ${index}: value="${select.value}", inside form: ${form.contains(select)}`);
                });
                
                // Check all form elements
                const allFormElements = form.querySelectorAll('input, select, textarea');
                console.log('Total form elements:', allFormElements.length);
                allFormElements.forEach((el, index) => {
                    if (el.name) {
                        console.log(`Form element ${index}: name="${el.name}", value="${el.value}"`);
                    }
                });
                
                debugFormData();
                // Don't prevent submission, just log it
            });
        }
    } catch (error) {
        console.error('Error initializing:', error);
    }
});
</script>
{% endblock %}
